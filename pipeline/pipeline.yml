---
resource_types:

- name: kubernetes
  type: docker-image
  source:
    repository: virtmerlin/concourse-kubernetes-resource

- name: harbor-image
  privileged: true
  type: docker-image
  source:
    repository: virtmerlin/harbor-image-resource

resources:

- name: secure-docker-image-build-ci
  type: git
  source:
    uri: https://github.com/virtmerlin/secure-docker-image-build-ci
    branch: master

- name: git-go-http
  type: git
  source:
    uri: https://github.com/tkrausjr/go-http
    branch: master

- name: harbor
  type: harbor-image
  source:
    username: ((harbor_username))
    password: ((harbor_password))
    skip_pull: true
    repository: ((harbor_url))/((harbor_image))
    insecure_registries:
    - ((harbor_url))

jobs:

- name: build-docker-image
  plan:
  - get: git-go-http
  - put: harbor
    params: {build: git-go-http}

- name: cve-report-harbor-image
  plan:
  - aggregate:
    - get: secure-docker-image-build-ci
    - get: git-go-http
      passed: [build-docker-image]
      trigger: true
  - task: clair-cve-report
    file: secure-docker-image-build-ci/tasks/cve-report-harbor-image/task.yml
    params:
      harbor_username: ((harbor_username))
      harbor_password: ((harbor_password))
      harbor_url: ((harbor_url))
      harbor_repository: ((harbor_image))
